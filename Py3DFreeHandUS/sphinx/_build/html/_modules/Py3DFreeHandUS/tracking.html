<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Py3DFreeHandUS.tracking &mdash; Py3DFreeHandUS 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Py3DFreeHandUS 1.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Py3DFreeHandUS 1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for Py3DFreeHandUS.tracking</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: tracking</span>
<span class="sd">   :synopsis: module for features tracking (e.g. muscle-tendon junction)</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">image_utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">converters</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">SimpleITK</span> <span class="kn">as</span> <span class="nn">sitk</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="kn">as</span> <span class="nn">mpatches</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span><span class="p">,</span> <span class="n">PowerNorm</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">feature</span>




<div class="viewcode-block" id="showImageQualityStatsPreOF"><a class="viewcode-back" href="../../api/api.html#Py3DFreeHandUS.tracking.showImageQualityStatsPreOF">[docs]</a><span class="k">def</span> <span class="nf">showImageQualityStatsPreOF</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates quality indices for before optical flow computation.</span>
<span class="sd">    </span>
<span class="sd">    .. note::</span>
<span class="sd">    </span>
<span class="sd">        These considerations are important: </span>
<span class="sd">        </span>
<span class="sd">        - Better to use a greyscale images, so that the eye does not focus on the </span>
<span class="sd">          type of color but only on the value;</span>
<span class="sd">          </span>
<span class="sd">        - For Shi-Tomasi corner response, better to use a logarithmic scale to </span>
<span class="sd">          smooth the left/right border effect (high values). Moreover, some image </span>
<span class="sd">          types (e.g. US) might have artificial symbols on it, bringing intrinsic</span>
<span class="sd">          high corner response;</span>
<span class="sd">          </span>
<span class="sd">        - For the sake of function generality, min and max for each image are not </span>
<span class="sd">          normalized to fixed values, since these may depend on the input type.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    I : np.ndarray</span>
<span class="sd">        2D grey-scale image.</span>
<span class="sd">    </span>
<span class="sd">    show : bool</span>
<span class="sd">        Plot results window or not.      </span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    
    <span class="c"># Plot original image</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Original&#39;</span><span class="p">)</span>
    
<span class="c">#    # Compute Harris corner measure response image.</span>
<span class="c">#    Ihar = feature.corner_harris(I, method=&#39;k&#39;, k=0.05, eps=1e-06, sigma=3)</span>
<span class="c">#    plt.subplot(2, 2, 2)</span>
<span class="c">#    #plt.imshow(Ihar, cmap=plt.cm.gray, norm=LogNorm())</span>
<span class="c">#    plt.imshow(Ihar, cmap=plt.cm.gray)</span>
<span class="c">#    plt.grid()</span>
<span class="c">#    plt.colorbar()</span>
<span class="c">#    plt.title(&#39;Harris response&#39;)</span>
    
    <span class="c"># Compute Shi-Tomasi (Kanade-Tomasi) corner measure response image.</span>
    <span class="n">Isht</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">corner_shi_tomasi</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Isht</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
    <span class="c">#plt.imshow(Isht, cmap=plt.cm.gray)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Shi-Tomasi response&#39;</span><span class="p">)</span>
    
    <span class="c"># Compute Marquez-Valle condition number.</span>
    <span class="n">Axx</span><span class="p">,</span> <span class="n">Axy</span><span class="p">,</span> <span class="n">Ayy</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">structure_tensor</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">structure_tensor_eigvals</span><span class="p">(</span><span class="n">Axx</span><span class="p">,</span> <span class="n">Axy</span><span class="p">,</span> <span class="n">Ayy</span><span class="p">)</span>
    <span class="n">Icon</span> <span class="o">=</span> <span class="n">l1</span> <span class="o">/</span> <span class="n">l2</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Icon</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Condition number&#39;</span><span class="p">)</span>
    
    <span class="c"># Show plots</span>
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    
    
    

    </div>
<div class="viewcode-block" id="enhanceMTJForTracking"><a class="viewcode-back" href="../../api/api.html#Py3DFreeHandUS.tracking.enhanceMTJForTracking">[docs]</a><span class="k">def</span> <span class="nf">enhanceMTJForTracking</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">enhanceArgs</span><span class="p">,</span> <span class="n">enhanceKwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function for enhancing the image containing muscle-tendon junction (MTJ)</span>
<span class="sd">    for tracking purpose. Two characteristics can be enhanced: </span>
<span class="sd">    - contrast (by histogram equalization)</span>
<span class="sd">    - signal-to-noise ratio (by smoothing)</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    img : np.ndarray</span>
<span class="sd">        Image to be enhanced.</span>

<span class="sd">    method : str</span>
<span class="sd">        Method for enhancing the image:</span>
<span class="sd">        </span>
<span class="sd">        - &#39;histeq&#39;: histogram equalization.</span>
<span class="sd">        </span>
<span class="sd">        - &#39;clahe&#39;: Contrast-Limited Adaptive Histogram Equalization</span>
<span class="sd">        (see ``cv2.createCLAHE()``). It uses ``enhanceKwargs``.</span>
<span class="sd">        </span>
<span class="sd">        - &#39;smooth&#39;: smoothing with Gaussian kernel</span>
<span class="sd">        (see ``cv2.GaussianBlur()``). It uses ``enhanceArgs``.</span>
<span class="sd">        </span>
<span class="sd">        There are other methods, where &#39;_opt&#39; is happended, that do not need</span>
<span class="sd">        further (further) arguments. Here, we are experimenting optimal settings.</span>
<span class="sd">        </span>
<span class="sd">    enhanceArgs : tuple</span>
<span class="sd">        List of arguments that can be needed by the enhancing functions.</span>
<span class="sd">        </span>
<span class="sd">    enhanceKwargs : dict</span>
<span class="sd">        List of keyword arguments that can be needed by the enhancing functions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Enhance image.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;histeq&#39;</span><span class="p">:</span>
        <span class="n">img2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">equalizeHist</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;clahe&#39;</span><span class="p">:</span>
        <span class="n">clahe</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">createCLAHE</span><span class="p">(</span><span class="o">**</span><span class="n">enhanceKwargs</span><span class="p">)</span>
        <span class="n">img2</span> <span class="o">=</span> <span class="n">clahe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;clahe_opt&#39;</span><span class="p">:</span>
        <span class="n">clahe</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">createCLAHE</span><span class="p">(</span><span class="n">clipLimit</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">tileGridSize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
        <span class="n">img2</span> <span class="o">=</span> <span class="n">clahe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;smooth&#39;</span><span class="p">:</span>
        <span class="n">img2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="o">*</span><span class="n">enhanceArgs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;smooth_opt&#39;</span><span class="p">:</span>
        <span class="n">img2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">img</span><span class="p">,(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img2</span>
    

    </div>
<div class="viewcode-block" id="calcVelocityLee2008"><a class="viewcode-back" href="../../api/api.html#Py3DFreeHandUS.tracking.calcVelocityLee2008">[docs]</a><span class="k">def</span> <span class="nf">calcVelocityLee2008</span><span class="p">(</span><span class="n">allDx</span><span class="p">,</span> <span class="n">allDy</span><span class="p">,</span> <span class="n">pctEx</span><span class="p">,</span> <span class="n">pctIn</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s">&#39;max_avg_vel&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implements the method described in the article of Lee et al 2008</span>
<span class="sd">    for calculating the muscle-tendon junction (MTJ) velocity vector (u, v) </span>
<span class="sd">    between a frame and the next one.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    allDx, allDy : np.ndarray</span>
<span class="sd">        X and Y component for velocities from for pixel in the rectangle mask.</span>

<span class="sd">    pctEx : float</span>
<span class="sd">        Number (between 0 and 1) indicating the percentage of velocities, in the</span>
<span class="sd">        beginning and end of sorted lists, to exclude. In the original article,</span>
<span class="sd">        this value was 0.1.</span>
<span class="sd">        </span>
<span class="sd">    pctIn : float</span>
<span class="sd">        Number (between 0 and 1) indicating the percentage of velocities, in the</span>
<span class="sd">        beginning and end of remaining sorted lists, to use for the average. </span>
<span class="sd">        In the original article, this value was 0.05.</span>
<span class="sd">        </span>
<span class="sd">    direction : string</span>
<span class="sd">        It defines which of the 2 average velocities (beginning and end of list)</span>
<span class="sd">        to use as final velocity.</span>
<span class="sd">        If &#39;max_avg_vel&#39;, the choice is determined by the absolute magnitude of </span>
<span class="sd">        the average velocity (as in the original article by Lee).</span>
<span class="sd">        If &#39;pct_sign&#39;, the choice is determined by the dominant number of </span>
<span class="sd">        velocitied concording in sign. If there is an equal number of positive</span>
<span class="sd">        and negative velocities, then the algorithm proceeds as for &#39;max_avg_vel&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        Velocity vector (u, v) for the MTJ.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">mask_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">allDx</span><span class="p">)</span>
    <span class="n">mask_u</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">mask_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">allDy</span><span class="p">)</span>
    <span class="n">mask_v</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">all_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">allDx</span><span class="p">)</span>
    <span class="n">all_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">allDy</span><span class="p">)</span>
    <span class="n">idx_u_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">allDx</span><span class="p">)</span>
    <span class="n">idx_v_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">allDy</span><span class="p">)</span>
    <span class="n">Np</span> <span class="o">=</span> <span class="n">all_u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">55.</span> <span class="o">*</span> <span class="mf">100.</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">all_u</span> <span class="o">=</span> <span class="n">all_u</span><span class="p">[</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">:</span><span class="o">-</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">]</span>
        <span class="n">idx_u</span> <span class="o">=</span> <span class="n">idx_u_</span><span class="p">[</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">:</span><span class="o">-</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">]</span>
        <span class="n">mask_u</span><span class="p">[</span><span class="n">idx_u</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">all_v</span> <span class="o">=</span> <span class="n">all_v</span><span class="p">[</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">:</span><span class="o">-</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">]</span>
        <span class="n">idx_v</span> <span class="o">=</span> <span class="n">idx_v_</span><span class="p">[</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">:</span><span class="o">-</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">]</span>
        <span class="n">mask_v</span><span class="p">[</span><span class="n">idx_v</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">u_avg_1</span> <span class="o">=</span> <span class="n">all_u</span><span class="p">[:</span><span class="n">Np</span><span class="o">*</span><span class="n">pctIn</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">v_avg_1</span> <span class="o">=</span> <span class="n">all_v</span><span class="p">[:</span><span class="n">Np</span><span class="o">*</span><span class="n">pctIn</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">u_avg_2</span> <span class="o">=</span> <span class="n">all_u</span><span class="p">[</span><span class="o">-</span><span class="n">Np</span><span class="o">*</span><span class="n">pctIn</span><span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">v_avg_2</span> <span class="o">=</span> <span class="n">all_v</span><span class="p">[</span><span class="o">-</span><span class="n">Np</span><span class="o">*</span><span class="n">pctIn</span><span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s">&#39;max_avg_vel&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_avg_1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_avg_2</span><span class="p">):</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">u_avg_1</span>
            <span class="n">mask_u</span><span class="p">[</span><span class="n">idx_u</span><span class="p">[:</span><span class="n">Np</span><span class="o">*</span><span class="n">pctIn</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">mask_u</span><span class="p">[</span><span class="n">idx_u_</span><span class="p">[:</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">u_avg_2</span>
            <span class="n">mask_u</span><span class="p">[</span><span class="n">idx_u</span><span class="p">[</span><span class="o">-</span><span class="n">Np</span><span class="o">*</span><span class="n">pctIn</span><span class="p">:]]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">mask_u</span><span class="p">[</span><span class="n">idx_u_</span><span class="p">[</span><span class="o">-</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">:]]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v_avg_1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v_avg_2</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v_avg_1</span>
            <span class="n">mask_v</span><span class="p">[</span><span class="n">idx_v</span><span class="p">[:</span><span class="n">Np</span><span class="o">*</span><span class="n">pctIn</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">mask_v</span><span class="p">[</span><span class="n">idx_v_</span><span class="p">[:</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v_avg_2</span>
            <span class="n">mask_v</span><span class="p">[</span><span class="n">idx_v</span><span class="p">[</span><span class="o">-</span><span class="n">Np</span><span class="o">*</span><span class="n">pctIn</span><span class="p">:]]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">mask_v</span><span class="p">[</span><span class="n">idx_v_</span><span class="p">[</span><span class="o">-</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">:]]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s">&#39;pct_sign&#39;</span><span class="p">:</span>
        <span class="n">direction_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">all_u</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">direction_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">all_v</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">direction_u</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">u_avg_1</span>
            <span class="n">mask_u</span><span class="p">[</span><span class="n">idx_u</span><span class="p">[:</span><span class="n">Np</span><span class="o">*</span><span class="n">pctIn</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">mask_u</span><span class="p">[</span><span class="n">idx_u_</span><span class="p">[:</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">direction_u</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">u_avg_2</span>
            <span class="n">mask_u</span><span class="p">[</span><span class="n">idx_u</span><span class="p">[</span><span class="o">-</span><span class="n">Np</span><span class="o">*</span><span class="n">pctIn</span><span class="p">:]]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">mask_u</span><span class="p">[</span><span class="n">idx_u_</span><span class="p">[</span><span class="o">-</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">:]]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_avg_1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_avg_2</span><span class="p">):</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">u_avg_1</span>
                <span class="n">mask_u</span><span class="p">[</span><span class="n">idx_u</span><span class="p">[:</span><span class="n">Np</span><span class="o">*</span><span class="n">pctIn</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">mask_u</span><span class="p">[</span><span class="n">idx_u_</span><span class="p">[:</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">u_avg_2</span>
                <span class="n">mask_u</span><span class="p">[</span><span class="n">idx_u</span><span class="p">[</span><span class="o">-</span><span class="n">Np</span><span class="o">*</span><span class="n">pctIn</span><span class="p">:]]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">mask_u</span><span class="p">[</span><span class="n">idx_u_</span><span class="p">[</span><span class="o">-</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">:]]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="n">direction_v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v_avg_1</span>
            <span class="n">mask_v</span><span class="p">[</span><span class="n">idx_v</span><span class="p">[:</span><span class="n">Np</span><span class="o">*</span><span class="n">pctIn</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">mask_u</span><span class="p">[</span><span class="n">idx_u_</span><span class="p">[:</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">direction_v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v_avg_2</span>
            <span class="n">mask_v</span><span class="p">[</span><span class="n">idx_v</span><span class="p">[</span><span class="o">-</span><span class="n">Np</span><span class="o">*</span><span class="n">pctIn</span><span class="p">:]]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">mask_v</span><span class="p">[</span><span class="n">idx_v_</span><span class="p">[</span><span class="o">-</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">:]]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v_avg_1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v_avg_2</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v_avg_1</span>
                <span class="n">mask_v</span><span class="p">[</span><span class="n">idx_v</span><span class="p">[:</span><span class="n">Np</span><span class="o">*</span><span class="n">pctIn</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">mask_v</span><span class="p">[</span><span class="n">idx_v_</span><span class="p">[:</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v_avg_2</span>
                <span class="n">mask_v</span><span class="p">[</span><span class="n">idx_v</span><span class="p">[</span><span class="o">-</span><span class="n">Np</span><span class="o">*</span><span class="n">pctIn</span><span class="p">:]]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">mask_v</span><span class="p">[</span><span class="n">idx_v_</span><span class="p">[</span><span class="o">-</span><span class="n">Np</span><span class="o">*</span><span class="n">pctEx</span><span class="p">:]]</span> <span class="o">=</span> <span class="mi">3</span>
            
    <span class="k">return</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">mask_u</span><span class="p">,</span> <span class="n">mask_v</span>
    
    </div>
<span class="k">def</span> <span class="nf">getFileExt</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">ext</span>
    


<div class="viewcode-block" id="trackMTJ"><a class="viewcode-back" href="../../api/api.html#Py3DFreeHandUS.tracking.trackMTJ">[docs]</a><span class="k">def</span> <span class="nf">trackMTJ</span><span class="p">(</span>
            <span class="n">imgFile</span><span class="p">,</span>
            <span class="n">plotRawInputImage</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">f1</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">f2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">y2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">enhanceImage</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">enhancePars</span><span class="o">=</span><span class="p">[(</span><span class="s">&#39;smooth_opt&#39;</span><span class="p">,)],</span>
            <span class="n">lowpassFilterTime</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">lowpassFilterTimePars</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mf">0.25</span><span class="p">),</span>
            <span class="n">cx</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cy</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mi">71</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mi">131</span><span class="p">,</span> <span class="n">adjustManuallyCxy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cxyHelp</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">cxOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cyOffset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">adjustManuallyCxyOffset</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">stepFramesN</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">technique</span><span class="o">=</span><span class="s">&#39;optical_flow&#39;</span><span class="p">,</span> <span class="n">techniquePars</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;lk_opt&#39;</span><span class="p">,</span><span class="s">&#39;new_centered_mask&#39;</span><span class="p">,</span><span class="s">&#39;feature_opt&#39;</span><span class="p">,</span><span class="s">&#39;kmeans_Lee2008&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.05</span><span class="p">),</span>
            <span class="n">plotImageInTracking</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">timePerImage</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span> <span class="n">plotTrackedFeatures</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">plotCircle</span><span class="o">=</span><span class="s">&#39;last&#39;</span><span class="p">,</span>
            <span class="n">plotTechniqueRes</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">saveTechniqueResTo</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">outFiles</span><span class="o">=</span><span class="p">[]</span>     
            <span class="p">):</span>
                
    <span class="sd">&quot;&quot;&quot;Function for tracking muscle-tendon junction (MTJ) automatically.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    imgFile : str</span>
<span class="sd">        Full path to the 3D sequence file to open.</span>
<span class="sd">        </span>
<span class="sd">    plotRawInputImage : bool</span>
<span class="sd">        If True, 3D sequence will be shown. ImageJ is required in this case.</span>
<span class="sd">        </span>
<span class="sd">    f1, f2 : mixed</span>
<span class="sd">        If positive integer, the 3D sequence will be cut between frame f1 and f2.</span>
<span class="sd">        If f1 of f2 are None, respectively the beginning or end will not be cut.</span>
<span class="sd">        </span>
<span class="sd">    y1, y2 : mixed</span>
<span class="sd">        If positive integer, the 3D sequence will be cut between coordinates</span>
<span class="sd">        y1 and y2, in height. Image origin (0, 0) is at the top-left corner.</span>
<span class="sd">        If y1 of y2 are None, respectively the beginning or end will not be cut.</span>
<span class="sd">        </span>
<span class="sd">    x1, x2 : mixed</span>
<span class="sd">        If positive integer, the 3D sequence will be cut between coordinates</span>
<span class="sd">        x1 and x2, in width.</span>
<span class="sd">        If x1 of x2 are None, respectively the beginning or end will not be cut.</span>
<span class="sd">        </span>
<span class="sd">    enhanceImage : bool</span>
<span class="sd">        If True, each 2D image will be enhanced for tracking, using parameters </span>
<span class="sd">        specified by ``enhancePars``.</span>
<span class="sd">        </span>
<span class="sd">    enhancePars : list</span>
<span class="sd">        List of tuples, each representing a step in the 2D images enhancing </span>
<span class="sd">        process. Each tuple contains second, third and fourth arguments for</span>
<span class="sd">        the function ``enhanceMTJForTracking()``.</span>
<span class="sd">        </span>
<span class="sd">    lowpassFilterTime : bool</span>
<span class="sd">        If True, each 2D image pixel will be low-pass filtered in time, using</span>
<span class="sd">        parameters specified by ``lowpassFilterTimePars``.</span>
<span class="sd">        </span>
<span class="sd">    lowpassFilterTimePars : tuple</span>
<span class="sd">        List of parameters indicating the parameter for the Butterworth digital</span>
<span class="sd">        low-pass filter. The first one is the filter order, the second one the</span>
<span class="sd">        cut-off frequency.</span>
<span class="sd">        </span>
<span class="sd">    cx, cy : int</span>
<span class="sd">        Rectangular mask center position for frame ``f1`` (or 0). This mask is </span>
<span class="sd">        used by the tracking algorithm (see details). If None, they will be set</span>
<span class="sd">        to the center of the frame.</span>
<span class="sd">    </span>
<span class="sd">    h, w : int</span>
<span class="sd">        Mask height and width.      </span>
<span class="sd">        </span>
<span class="sd">    adjustManuallyCxy : bool</span>
<span class="sd">        If True, the process will stop and allow the user to select manually</span>
<span class="sd">        the center of the mask, on the image ``f1`` (or 0). The window has to</span>
<span class="sd">        be close manually for proceeding.</span>
<span class="sd">        </span>
<span class="sd">    cxyHelp : dict</span>
<span class="sd">        Dictionary where keys are time frame indices and values are tuples</span>
<span class="sd">        containing x and y values for the rectangular mask center.</span>
<span class="sd">        If provided, the mask center will be set to this value, ignoring what</span>
<span class="sd">        the tracking algorithm found.</span>
<span class="sd">        </span>
<span class="sd">    cxOffset, cyOffset : int</span>
<span class="sd">        It represents the offset between the mask center and the MTJ point.</span>
<span class="sd">        </span>
<span class="sd">    adjustManuallyCxyOffset : bool</span>
<span class="sd">        If True, the process will stop and allow the user to select manually</span>
<span class="sd">        the MTJ location, on the image ``f1`` (or 0). The window has to</span>
<span class="sd">        be close manually for proceeding.</span>
<span class="sd">        </span>
<span class="sd">    stepFramesN : int</span>
<span class="sd">        It represents the number of frames to jump ahead after is performed</span>
<span class="sd">        for current image. If equal or greater than 2, (stepFramesN-1) frames</span>
<span class="sd">        will be skipped.</span>
<span class="sd">        It can be increased to simulate lower acquisition frequencies for the </span>
<span class="sd">        input file, or larger motion velocities.</span>
<span class="sd">        </span>
<span class="sd">    technique : str</span>
<span class="sd">        String indicating the technique used (see parameter ``techniquePars``</span>
<span class="sd">        for details). Possible values are: &#39;optical_flow&#39;, &#39;template_match&#39;</span>
<span class="sd">        (deprecated).</span>
<span class="sd">        </span>
<span class="sd">    techniquePars : tuple</span>
<span class="sd">        List of parameters used by the tracking algorithm.</span>
<span class="sd">        If ``technique`` is &#39;optical_flow&#39;:</span>
<span class="sd">        </span>
<span class="sd">            0.  Lukas-Kanade parameters for optical field calculation.</span>
<span class="sd">                If dictionary, see keyword parameters for ``cv2.calcOpticalFlowPyrLK()``.</span>
<span class="sd">                If &#39;lk_opt&#39;, the optimal parameters will be used.</span>
<span class="sd">                </span>
<span class="sd">            1.  Features to be tracked.</span>
<span class="sd">                If &#39;new_centered_mask&#39;, a new mask will be created around the </span>
<span class="sd">                detected MTJ, and all the points contained in the mask will be </span>
<span class="sd">                tracked.</span>
<span class="sd">                If &#39;good_features&#39;, only the features detected as the trackable</span>
<span class="sd">                and tracked (**good features**) will be tracked.</span>
<span class="sd">                If &#39;corners_in_centered_mask&#39;, only the the Shi-Tomasi corners in</span>
<span class="sd">                a mask centered around the the detected MTJ will be tracked.</span>
<span class="sd">                If &#39;append_corners_to_new_good_features_in_centered_mask&#39;, </span>
<span class="sd">                Shi-Tomasi corners in the new form will be appended to the good </span>
<span class="sd">                features detected. This full list of features will be tracked.</span>
<span class="sd">                </span>
<span class="sd">            2.  Parameters for finding corners by using the Shi-Tomasi algorithm.</span>
<span class="sd">                If dictionary, see keyword parameters for ``cv2.goodFeaturesToTrack()``.</span>
<span class="sd">                If &#39;feature_opt&#39;, the optimal parameters will be used.</span>
<span class="sd">                </span>
<span class="sd">            3.  Algorithm for processing optical flow results.</span>
<span class="sd">                If &#39;Lee2008&#39;, the method described by Lee at all 2008 is applied</span>
<span class="sd">                (see ``calcVelocityLee2008(..., direction=&#39;max_avg_vel&#39;)``).</span>
<span class="sd">                If &#39;Lee2008_v2&#39;, the method described by Lee at all 2008 is</span>
<span class="sd">                applied, with some small modifications</span>
<span class="sd">                (see ``calcVelocityLee2008(..., direction=&#39;max_avg_vel&#39;)``).</span>
<span class="sd">                If &#39;avg_good_features&#39;, an average of the position of the good </span>
<span class="sd">                features detected is calculated.</span>
<span class="sd">                If &#39;lrmost_x_good_features&#39;, these further parameters are used::</span>
<span class="sd">                </span>
<span class="sd">                    uTh = techniquePars[4]</span>
<span class="sd">                    nKeep = techniquePars[5]</span>
<span class="sd">                    </span>
<span class="sd">                For the good features, it calculates the median of the velocities </span>
<span class="sd">                in the x direction. If the velocity is bigger in module than ``uTh``,</span>
<span class="sd">                then there is a condition of motion. In this case, only the rightmost</span>
<span class="sd">                or leftmost (depending if the motion is going respectively to the </span>
<span class="sd">                right or left) ``nKeep`` good features are retained. And for these,</span>
<span class="sd">                the median position is calculated, this being the new MTJ position. </span>
<span class="sd">                The other features are deleted from the list of good features. </span>
<span class="sd">                If the velocity is smaller in module than ``uTh``, then there is a</span>
<span class="sd">                condition of rest. The median position for all the good features is </span>
<span class="sd">                calculated.</span>
<span class="sd">                &#39;lrmost_x_good_features_adv&#39; is similar to &#39;lrmost_x_good_features&#39;,</span>
<span class="sd">                but with an auto-recovery procedure added in motion state. If</span>
<span class="sd">                the three previous velocites are, in average, in motion state</span>
<span class="sd">                as well but with opposite direction, then the point is not being</span>
<span class="sd">                properly tracked. In this case, the new MTJ position is set to the </span>
<span class="sd">                current one, but the mask is enlarged (50% in both dimensions), to </span>
<span class="sd">                ensure a bigger search zone for the next iteration.</span>
<span class="sd">                </span>
<span class="sd">                .. note::</span>
<span class="sd">        </span>
<span class="sd">                    Algorithms &#39;lrmost_x_good_features&#39; and &#39;lrmost_x_good_features_adv&#39;</span>
<span class="sd">                    were developed for the specific motion of the MTJ, that is:</span>
<span class="sd">                    </span>
<span class="sd">                    - mostly horizontal in the images, some vertical motion is allowed as well.</span>
<span class="sd">                    </span>
<span class="sd">                    - cyclic, from left to right or vice-versa.</span>
<span class="sd">                </span>
<span class="sd">                If &#39;kmeans_Lee2008&#39;, these further parameters are used::</span>
<span class="sd">                </span>
<span class="sd">                    nClusters = techniquePars[4]</span>
<span class="sd">                    clusterOnlyVelocity = techniquePars[5]</span>
<span class="sd">                    pctEx = techniquePars[6]</span>
<span class="sd">                    pctIn = techniquePars[7]</span>
<span class="sd">                    </span>
<span class="sd">                Firstly, the a k-means clustering is performed on the good features, </span>
<span class="sd">                on both velocity and position, or velocity only, depending on the</span>
<span class="sd">                parameter ``clusterOnlyVelocity``. This last flag would allow the </span>
<span class="sd">                user to have cluster that are separated in space. The number of </span>
<span class="sd">                clusters must be specified manually, by ``nClusters``.</span>
<span class="sd">                Secondly, the cluster with the biggest number of points is selected.</span>
<span class="sd">                Lastly, the algorithm by Lee et al 2008 is applied on these points</span>
<span class="sd">                (see ``calcVelocityLee2008()``). ``pctEx`` and ``pctIn`` will be</span>
<span class="sd">                used.</span>
<span class="sd">                </span>
<span class="sd">            4.  From here down, these are parameters for the algorithm at point 3.</span>
<span class="sd">            </span>
<span class="sd">            </span>
<span class="sd">        If ``technique`` is &#39;template_match&#39;:</span>
<span class="sd">        </span>
<span class="sd">            0.  Allowed motion (in pixels) of the template in horizontal.</span>

<span class="sd">            1.  Allowed motion (in pixels) of the template in vertical.</span>
<span class="sd">            </span>
<span class="sd">        </span>
<span class="sd">    plotImageInTracking : bool</span>
<span class="sd">        If True, each 2D image is shown on screen during the tracking process.</span>
<span class="sd">        </span>
<span class="sd">    timePerImage : mixed</span>
<span class="sd">        Time for which each 2D image is shown on screen.</span>
<span class="sd">        If &#39;auto&#39;, it is automatically calculated from the meta-data in</span>
<span class="sd">        ``imgFile``. If not available here, an exception will thrown.</span>
<span class="sd">        If float, it must be indicated in milliseconds.</span>
<span class="sd">        If ``plotImageInTracking`` is False, this parameter is ignored.</span>
<span class="sd">        </span>
<span class="sd">    plotTrackedFeatures : bool</span>
<span class="sd">        If True, plot the features tracked by the optical flow algorithm.</span>
<span class="sd">        If ``technique`` is not &#39;optical_flow&#39; or if ``plotImageInTracking`` is</span>
<span class="sd">        False, this parameter is ignored.</span>
<span class="sd">        </span>
<span class="sd">    plotCircle : str</span>
<span class="sd">        MTJ point is represented as the center of a circle.</span>
<span class="sd">        If &#39;all&#39;, image *i* contains the circles from image 0 to *i*.</span>
<span class="sd">        If &#39;last&#39;, only the circle in the current image is plotted.</span>
<span class="sd">        If ``plotImageInTracking`` is False, this parameter is ignored.</span>
<span class="sd">        </span>
<span class="sd">    plotTechniqueRes : bool</span>
<span class="sd">        If True, plot additional data produced during the tracking stage.</span>
<span class="sd">        Execution of the program *is interrupted* until the results windows</span>
<span class="sd">        are manually closed.</span>
<span class="sd">        If ``technique`` is &#39;optical_flow&#39;, the optical flow is plotted, where</span>
<span class="sd">        arrows represent the current (u, v) velocity vector field for the points</span>
<span class="sd">        inside the rectangle. Around the center of the rectangle, a blue arrow </span>
<span class="sd">        is plotted, indicating the velocity of the MTJ towards the next image.</span>
<span class="sd">        Arrows lengths and directions have the same scale of the x-y axis.</span>
<span class="sd">        If the algorithm used is &#39;kmeans_Lee2008&#39;, arrows will be coloured </span>
<span class="sd">        differently for different clusters. The biggest cluster is coloured in</span>
<span class="sd">        blue. For any other algorithm, velocities for good features are coloured</span>
<span class="sd">        in green, otherwise in red.</span>
<span class="sd">        If ``technique`` is &#39;template_match&#39;, template on the previous image</span>
<span class="sd">        (smaller rectangle), search window (bigger rectangle), matching indices</span>
<span class="sd">        (in greyscale), point with best match and its value are saved for each</span>
<span class="sd">        time frame. </span>
<span class="sd">        </span>
<span class="sd">    saveTechniqueResTo : mixed</span>
<span class="sd">        Path for saving technique results. If None, no data will be saved.</span>
<span class="sd">        If str, it must specify the full folder path.</span>
<span class="sd">        If ``technique`` is &#39;optical_flow&#39;, the figures created by using the</span>
<span class="sd">        flag ``plotTechniqueRes`` are saved. Plus, numeric data about the</span>
<span class="sd">        velocities is saved as text files.</span>
<span class="sd">        If ``technique`` is &#39;template_match&#39;, the figures created by using the</span>
<span class="sd">        flag ``plotTechniqueRes`` are saved.        </span>
<span class="sd">        </span>
<span class="sd">    outFiles : list</span>
<span class="sd">        List of tuples, where each tuple represents an output video to be saved.</span>
<span class="sd">        The first element is the full path of the file to be saved. Supported</span>
<span class="sd">        formats: avi (Microsoft Video 1 (MSVC) codec).</span>
<span class="sd">        The second element is the frame rate. If &#39;auto&#39;, the frame rate of the</span>
<span class="sd">        input file. Otherwise, it must be a float number.</span>
<span class="sd">        </span>
<span class="sd">        </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        cx, cy, horizontal and vertical position of the MTJ. Values are relative</span>
<span class="sd">        to the (0, 0) image corner. These Numpy vectors contain as many frames as</span>
<span class="sd">        the original input image. Frames outside the range (f1, f2) are set as</span>
<span class="sd">        np.nan.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># Read image file</span>
    <span class="n">I</span><span class="p">,</span> <span class="n">image</span> <span class="o">=</span> <span class="n">readSITK</span><span class="p">(</span><span class="n">imgFile</span><span class="p">)</span>
    
    <span class="c"># Get frame rate</span>
    <span class="n">frame_rate</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">getFileExt</span><span class="p">(</span><span class="n">imgFile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&#39;dcm&#39;</span><span class="p">:</span>
        <span class="n">md_keys</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">GetMetaDataKeys</span><span class="p">()</span>
        <span class="n">cine_rate_key</span> <span class="o">=</span> <span class="s">&#39;0018|0040&#39;</span>
        <span class="k">if</span> <span class="n">cine_rate_key</span> <span class="ow">in</span> <span class="n">md_keys</span><span class="p">:</span>
            <span class="n">frame_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">GetMetaData</span><span class="p">(</span><span class="n">cine_rate_key</span><span class="p">))</span>
            
    <span class="c"># Get time per image</span>
    <span class="k">if</span> <span class="n">timePerImage</span> <span class="o">==</span> <span class="s">&#39;auto&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">frame_rate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">timePerImage</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1000.</span> <span class="o">/</span> <span class="n">frame_rate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;timePerImage cannot be calculated automatically&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">plotRawInputImage</span><span class="p">:</span>
        <span class="c"># Show images for exploration</span>
        <span class="n">sitk</span><span class="o">.</span><span class="n">Show</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    
    <span class="n">Nfr_orig</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c"># Crop image</span>
    <span class="k">if</span> <span class="n">f1</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">f2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">y1</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">y2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">x1</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">x2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="n">f1</span><span class="p">:</span><span class="n">f2</span><span class="p">,</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span><span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span>
    
    <span class="c"># Enhance images</span>
    <span class="n">Ienh</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">enhanceImage</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">I</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">enhanceStep</span> <span class="ow">in</span> <span class="n">enhancePars</span><span class="p">:</span>
                <span class="n">enhance_method</span><span class="p">,</span> <span class="n">enhance_args</span><span class="p">,</span> <span class="n">enhance_kwargs</span> <span class="o">=</span> <span class="n">enhanceStep</span> <span class="o">+</span> <span class="p">(</span><span class="bp">None</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">enhanceStep</span><span class="p">))</span>
                <span class="n">Ienh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">enhanceMTJForTracking</span><span class="p">(</span><span class="n">Ienh</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">enhance_method</span><span class="p">,</span> <span class="n">enhance_args</span><span class="p">,</span> <span class="n">enhance_kwargs</span><span class="p">)</span>
    
    <span class="c"># Time-filter image</span>
    <span class="k">if</span> <span class="n">lowpassFilterTime</span><span class="p">:</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="o">*</span><span class="n">lowpassFilterTimePars</span><span class="p">)</span>
        <span class="n">Ienh</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">filtfilt</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">Ienh</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Ienh</span><span class="p">[</span><span class="n">Ienh</span><span class="o">&gt;</span><span class="mi">255</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
        <span class="n">Ienh</span><span class="p">[</span><span class="n">Ienh</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">Ienh</span> <span class="o">=</span> <span class="n">Ienh</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        
    <span class="c"># Params for ShiTomasi corner detection</span>
    <span class="k">if</span> <span class="n">technique</span> <span class="o">==</span> <span class="s">&#39;optical_flow&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;feature_opt&#39;</span><span class="p">:</span>
            <span class="n">feature_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span> <span class="n">maxCorners</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                                   <span class="n">qualityLevel</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span>
                                   <span class="n">minDistance</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                   <span class="n">blockSize</span> <span class="o">=</span> <span class="mi">7</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">feature_params</span> <span class="o">=</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="c"># Parameters for lucas kanade optical flow</span>
    <span class="c">#http://stackoverflow.com/questions/23660409/what-is-the-criteria-epsilon-and-maxcount-from-calcopticalflowpyrlk</span>
    <span class="k">if</span> <span class="n">technique</span> <span class="o">==</span> <span class="s">&#39;optical_flow&#39;</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;lk_opt&#39;</span><span class="p">:</span>
            <span class="n">lk_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span> <span class="n">winSize</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span>   <span class="c"># if very low, there will be unrealistic dx,dy</span>
                              <span class="n">maxLevel</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                              <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_EPS</span> <span class="o">|</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_COUNT</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lk_params</span> <span class="o">=</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c"># Get first frame</span>
    <span class="n">old_frame</span> <span class="o">=</span> <span class="n">Ienh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">old_gray</span> <span class="o">=</span> <span class="n">old_frame</span>
        
    <span class="c"># Define window center</span>
    <span class="k">global</span> <span class="n">_cx</span><span class="p">,</span> <span class="n">_cy</span>
    <span class="n">_cx</span><span class="p">,</span> <span class="n">_cy</span> <span class="o">=</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span>
    <span class="k">def</span> <span class="nf">onmouseRect</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">_cx</span><span class="p">,</span><span class="n">_cy</span><span class="p">,</span><span class="n">p0</span>
        <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">cv2</span><span class="o">.</span><span class="n">EVENT_FLAG_LBUTTON</span><span class="p">:</span>
            <span class="n">_cx</span><span class="p">,</span> <span class="n">_cy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">createCenteredMaskCoords</span><span class="p">(</span><span class="n">_cx</span><span class="p">,</span> <span class="n">_cy</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)[:,</span><span class="bp">None</span><span class="p">,:]</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">pts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">pts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">area_col</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">old_gray</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_GRAY2BGR</span><span class="p">)</span>
            <span class="n">area_col2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">area_col</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),(</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">area_col2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">area_col</span> <span class="o">=</span> <span class="n">area_col2</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">area_col</span><span class="p">)</span>        
    
    <span class="n">win</span> <span class="o">=</span> <span class="s">&#39;Click on window center&#39;</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">old_gray</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">p0</span>  
    <span class="n">p0</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">setMouseCallback</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">onmouseRect</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cx</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">cy</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">onmouseRect</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>   <span class="c"># to show rectangle on prompt</span>
    <span class="k">if</span> <span class="n">adjustManuallyCxy</span><span class="p">:</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
    <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">_cx</span><span class="p">,</span> <span class="n">_cy</span>
    <span class="k">print</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span>
    
    <span class="c"># Define offset point</span>
    <span class="k">global</span> <span class="n">_cxo</span><span class="p">,</span> <span class="n">_cyo</span>
    <span class="n">_cxo</span><span class="p">,</span> <span class="n">_cyo</span> <span class="o">=</span> <span class="n">cxOffset</span> <span class="o">+</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cyOffset</span> <span class="o">+</span> <span class="n">cy</span>
    <span class="k">def</span> <span class="nf">onmouseOffset</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">_cxo</span><span class="p">,</span><span class="n">_cyo</span>
        <span class="k">if</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">cv2</span><span class="o">.</span><span class="n">EVENT_FLAG_LBUTTON</span><span class="p">:</span>
            <span class="n">_cxo</span><span class="p">,</span> <span class="n">_cyo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">area_col</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">old_gray</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_GRAY2BGR</span><span class="p">)</span>
            <span class="n">area_col2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">area_col</span><span class="p">,(</span><span class="nb">int</span><span class="p">(</span><span class="n">_cxo</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">_cyo</span><span class="p">)),</span><span class="mi">5</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">area_col2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">area_col</span> <span class="o">=</span> <span class="n">area_col2</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">area_col</span><span class="p">)</span>        
    
    <span class="n">win</span> <span class="o">=</span> <span class="s">&#39;Click on offset point&#39;</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">old_gray</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">setMouseCallback</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">onmouseOffset</span><span class="p">)</span>
    <span class="n">onmouseOffset</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">_cxo</span><span class="p">,</span> <span class="n">_cyo</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>   <span class="c"># to show point on prompt</span>
    <span class="k">if</span> <span class="n">adjustManuallyCxyOffset</span><span class="p">:</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">()</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
    <span class="n">cxo</span><span class="p">,</span> <span class="n">cyo</span> <span class="o">=</span> <span class="n">_cxo</span><span class="o">-</span><span class="n">cx</span><span class="p">,</span> <span class="n">_cyo</span><span class="o">-</span><span class="n">cy</span>
    <span class="k">print</span> <span class="n">cxo</span><span class="p">,</span> <span class="n">cyo</span>
    
    <span class="c">#features = &#39;corners_only&#39;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="s">&#39;all_points&#39;</span>
    <span class="k">if</span> <span class="n">features</span> <span class="o">==</span> <span class="s">&#39;all_points&#39;</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">features</span> <span class="o">==</span> <span class="s">&#39;corners_only&#39;</span><span class="p">:</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">goodFeaturesToTrack</span><span class="p">(</span><span class="n">old_gray</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">feature_params</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">p0</span>
    
    <span class="c"># Create some random colors</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,(</span><span class="n">h</span><span class="o">*</span><span class="n">w</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">color_quiver</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="c"># Create a mask image for drawing purposes</span>
    <span class="n">mask_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">old_frame</span><span class="p">)</span>
    <span class="n">mask_good</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">mask_good</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_GRAY2BGR</span><span class="p">)</span>
    <span class="n">mask_circle</span> <span class="o">=</span> <span class="n">mask_good</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">mask_empty</span> <span class="o">=</span> <span class="n">mask_good</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">Nfr</span> <span class="o">=</span> <span class="n">Ienh</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cx_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nfr_orig</span><span class="p">,))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">cy_res</span> <span class="o">=</span> <span class="n">cx_res</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">cx_res</span><span class="p">[</span><span class="n">f1</span><span class="p">],</span> <span class="n">cy_res</span><span class="p">[</span><span class="n">f1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">+</span> <span class="n">cxo</span><span class="p">,</span> <span class="n">cy</span> <span class="o">+</span> <span class="n">cyo</span>
     
    <span class="n">u_buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,))</span>
    <span class="n">Iout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">Ienh</span><span class="p">)</span>
    <span class="n">Iout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_gray</span>
    <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Nfr</span><span class="p">,</span> <span class="n">stepFramesN</span><span class="p">):</span>
        
        <span class="k">print</span> <span class="s">&#39;Frame: </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">)</span>
        
        <span class="c"># Get current frame</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">Ienh</span><span class="p">[</span><span class="n">fr</span><span class="p">]</span>
        <span class="n">frame_gray</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">frame_col</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_GRAY2BGR</span><span class="p">)</span>
        
        <span class="c"># Update old point</span>
        <span class="n">old_cx</span><span class="p">,</span> <span class="n">old_cy</span> <span class="o">=</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span>
        
        <span class="c"># Get rectangle borders</span>
        <span class="n">a_rect</span><span class="p">,</span> <span class="n">b_rect</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">p0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">c_rect</span><span class="p">,</span> <span class="n">d_rect</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">p0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    
        <span class="k">if</span> <span class="n">technique</span> <span class="o">==</span> <span class="s">&#39;optical_flow&#39;</span><span class="p">:</span>
    
            <span class="c"># Calculate (sparse) optical flow</span>
            <span class="n">p1</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">calcOpticalFlowPyrLK</span><span class="p">(</span><span class="n">old_gray</span><span class="p">,</span> <span class="n">frame_gray</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">lk_params</span><span class="p">)</span>
            
            <span class="c"># Select points</span>
            <span class="n">good_new</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="n">st</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">good_old</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">st</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">bad_new</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="n">st</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">bad_old</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[</span><span class="n">st</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">all_new</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]</span>
            <span class="n">all_old</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]</span>
            <span class="n">all_new_r</span><span class="p">,</span> <span class="n">all_new_c</span> <span class="o">=</span> <span class="n">all_new</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">all_new</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">all_old_r</span><span class="p">,</span> <span class="n">all_old_c</span> <span class="o">=</span> <span class="n">all_old</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">all_old</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">ar</span><span class="p">,</span> <span class="n">br</span> <span class="o">=</span> <span class="n">all_old_c</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">all_old_r</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            
            <span class="c"># Calculate error measures</span>
            <span class="n">all_err_fun</span> <span class="o">=</span> <span class="n">err</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mask_err_fun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>
            <span class="n">mask_err_fun</span><span class="p">[</span><span class="n">all_old_r</span><span class="o">-</span><span class="n">br</span><span class="p">,</span><span class="n">all_old_c</span><span class="o">-</span><span class="n">ar</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_err_fun</span>
            <span class="n">mask_err_OF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>
            <span class="n">mask_err_OF</span><span class="p">[</span><span class="n">all_old_r</span><span class="o">-</span><span class="n">br</span><span class="p">,</span><span class="n">all_old_c</span><span class="o">-</span><span class="n">ar</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">frame_gray</span><span class="p">[</span><span class="n">all_new_r</span><span class="p">,</span><span class="n">all_new_c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-</span> 
                                                          <span class="n">old_gray</span><span class="p">[</span><span class="n">all_old_r</span><span class="p">,</span><span class="n">all_old_c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="n">plotTrackedFeatures</span><span class="p">:</span>
                <span class="c"># draw the tracks</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">new</span><span class="p">,</span><span class="n">old</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">good_new</span><span class="p">,</span><span class="n">good_old</span><span class="p">)):</span>
                    <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                    <span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="o">=</span> <span class="n">old</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                    <span class="n">mask_good2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">mask_good</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">),(</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">),</span> <span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mask_good2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">mask_good</span> <span class="o">=</span> <span class="n">mask_good2</span>
                        
    
            <span class="n">all_x</span> <span class="o">=</span> <span class="n">all_old</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">all_y</span> <span class="o">=</span> <span class="n">all_old</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">all_dx</span> <span class="o">=</span> <span class="n">all_new</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">all_x</span>
            <span class="n">all_dy</span> <span class="o">=</span> <span class="n">all_new</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">all_y</span>
            <span class="n">good_x</span> <span class="o">=</span> <span class="n">good_old</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">good_y</span> <span class="o">=</span> <span class="n">good_old</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">good_dx</span> <span class="o">=</span> <span class="n">good_new</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">good_x</span>
            <span class="n">good_dy</span> <span class="o">=</span> <span class="n">good_new</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">good_y</span>
            <span class="n">bad_x</span> <span class="o">=</span> <span class="n">bad_old</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">bad_y</span> <span class="o">=</span> <span class="n">bad_old</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">bad_dx</span> <span class="o">=</span> <span class="n">bad_new</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">bad_x</span>
            <span class="n">bad_dy</span> <span class="o">=</span> <span class="n">bad_new</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bad_y</span>
            
            <span class="n">new_h</span><span class="p">,</span> <span class="n">new_w</span> <span class="o">=</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span>
            
            <span class="n">method</span> <span class="o">=</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;Lee2008&#39;</span><span class="p">:</span>
                <span class="n">pctEx</span> <span class="o">=</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">pctIn</span> <span class="o">=</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">mask_u</span><span class="p">,</span> <span class="n">mask_v</span> <span class="o">=</span> <span class="n">calcVelocityLee2008</span><span class="p">(</span><span class="n">all_dx</span><span class="p">,</span> <span class="n">all_dy</span><span class="p">,</span> <span class="n">pctEx</span><span class="p">,</span> <span class="n">pctIn</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s">&#39;max_avg_vel&#39;</span><span class="p">)</span>
                <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">old_cx</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span> <span class="n">old_cy</span> <span class="o">+</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;Lee2008_v2&#39;</span><span class="p">:</span>
                <span class="n">pctEx</span> <span class="o">=</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">pctIn</span> <span class="o">=</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">mask_u</span><span class="p">,</span> <span class="n">mask_v</span> <span class="o">=</span> <span class="n">calcVelocityLee2008</span><span class="p">(</span><span class="n">all_dx</span><span class="p">,</span> <span class="n">all_dy</span><span class="p">,</span> <span class="n">pctEx</span><span class="p">,</span> <span class="n">pctIn</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s">&#39;pct_sign&#39;</span><span class="p">)</span>
                <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">old_cx</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span> <span class="n">old_cy</span> <span class="o">+</span> <span class="n">v</span>                
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;avg_good_features&#39;</span><span class="p">:</span>
                <span class="n">cx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">good_new</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">good_new</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">-</span> <span class="n">old_cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">-</span> <span class="n">old_cy</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;lrmost_x_good_features&#39;</span><span class="p">:</span>
                <span class="n">u_th</span> <span class="o">=</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">N_keep</span> <span class="o">=</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">u_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">good_dx</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_avg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">u_th</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">u_avg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">idx_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">good_new</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])[:</span><span class="n">N_keep</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">idx_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">good_new</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])[</span><span class="o">-</span><span class="n">N_keep</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">idx_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">good_new</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">cx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">good_new</span><span class="p">[</span><span class="n">idx_x</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">good_new</span><span class="p">[</span><span class="n">idx_x</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">-</span> <span class="n">old_cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">-</span> <span class="n">old_cy</span>
                <span class="n">good_new</span> <span class="o">=</span> <span class="n">good_new</span><span class="p">[</span><span class="n">idx_x</span><span class="p">,:]</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;lrmost_x_good_features_adv&#39;</span><span class="p">:</span>
                <span class="n">u_th</span> <span class="o">=</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">N_keep</span> <span class="o">=</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">u_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">good_dx</span><span class="p">)</span>
                <span class="n">u_avg_buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">u_buffer</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&#39;horizontal avg velocity: </span><span class="si">%.2f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">u_avg</span>
                <span class="c"># Decide upon velocity</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_avg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">u_th</span><span class="p">:</span> <span class="c"># &quot;motion&quot; state      </span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">u_avg_buffer</span> <span class="o">*</span> <span class="n">u_avg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_avg_buffer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">u_th</span><span class="p">:</span> <span class="c"># opposite motion</span>
                        <span class="n">new_w</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
                        <span class="n">new_h</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
                        <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">old_cx</span><span class="p">,</span> <span class="n">old_cy</span>                        
                    <span class="k">else</span><span class="p">:</span> <span class="c"># realistic</span>
                        <span class="k">if</span> <span class="n">u_avg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">idx_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">good_new</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])[:</span><span class="n">N_keep</span><span class="p">]</span>
                            <span class="n">cx</span> <span class="o">=</span> <span class="n">good_new</span><span class="p">[</span><span class="n">idx_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">cy</span> <span class="o">=</span> <span class="n">good_new</span><span class="p">[</span><span class="n">idx_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">idx_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">good_new</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])[</span><span class="o">-</span><span class="n">N_keep</span><span class="p">:]</span>
                            <span class="n">cx</span> <span class="o">=</span> <span class="n">good_new</span><span class="p">[</span><span class="n">idx_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">cy</span> <span class="o">=</span> <span class="n">good_new</span><span class="p">[</span><span class="n">idx_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">good_new</span> <span class="o">=</span> <span class="n">good_new</span><span class="p">[</span><span class="n">idx_x</span><span class="p">,:]</span>
                <span class="k">else</span><span class="p">:</span> <span class="c"># &quot;resting&quot; state</span>
                    <span class="n">cx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">good_new</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">good_new</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">-</span> <span class="n">old_cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">-</span> <span class="n">old_cy</span>
                <span class="c"># Update velocity buffer</span>
                <span class="n">u_buffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">u_buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">u_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;kmeans_Lee2008&#39;</span><span class="p">:</span>
                <span class="n">nClusters</span> <span class="o">=</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">clusterOnlyVelocity</span> <span class="o">=</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">pctEx</span> <span class="o">=</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                <span class="n">pctIn</span> <span class="o">=</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                <span class="c"># Run k-means clustering</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">good_dx</span><span class="p">,</span><span class="n">good_dy</span><span class="p">,</span><span class="n">good_x</span><span class="p">,</span><span class="n">good_y</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
                <span class="n">criteria</span> <span class="o">=</span> <span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_EPS</span> <span class="o">+</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TERM_CRITERIA_MAX_ITER</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">clusterOnlyVelocity</span><span class="p">:</span>
                    <span class="n">Zc</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Zc</span> <span class="o">=</span> <span class="n">Z</span>
                <span class="n">ret_km</span><span class="p">,</span><span class="n">label_km</span><span class="p">,</span><span class="n">center_km</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">kmeans</span><span class="p">(</span><span class="n">Zc</span><span class="p">,</span><span class="n">nClusters</span><span class="p">,</span><span class="n">criteria</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">KMEANS_RANDOM_CENTERS</span><span class="p">)</span>
                <span class="c"># Search for biggest cluster                </span>
                <span class="n">Npoints</span> <span class="o">=</span> <span class="mi">0</span>            
                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nClusters</span><span class="p">):</span>
                    <span class="n">D</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">label_km</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">==</span><span class="n">l</span><span class="p">]</span> 
                    <span class="k">if</span> <span class="n">D</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Npoints</span><span class="p">:</span>
                        <span class="n">Npoints</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">l_max</span> <span class="o">=</span> <span class="n">l</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">label_km</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">==</span><span class="n">l_max</span><span class="p">]</span>
                <span class="c"># Calc velocity</span>
                <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">mask_u</span><span class="p">,</span> <span class="n">mask_v</span> <span class="o">=</span> <span class="n">calcVelocityLee2008</span><span class="p">(</span><span class="n">A</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">A</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">pctEx</span><span class="p">,</span> <span class="n">pctIn</span><span class="p">)</span>
                <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">old_cx</span> <span class="o">+</span> <span class="n">u</span><span class="p">,</span> <span class="n">old_cy</span> <span class="o">+</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                
            <span class="c"># Use manually inputted cxy if existing</span>
            <span class="k">if</span> <span class="n">f1</span><span class="o">+</span><span class="n">fr</span> <span class="ow">in</span> <span class="n">cxyHelp</span><span class="p">:</span>
                <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">cxyHelp</span><span class="p">[</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">cxo</span><span class="p">,</span> <span class="n">cxyHelp</span><span class="p">[</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">cyo</span>
                <span class="k">print</span> <span class="s">&#39;Point adjusted manually&#39;</span>

            <span class="k">print</span> <span class="s">&#39;Point velocity: (</span><span class="si">%.2f</span><span class="s">, </span><span class="si">%.2f</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;Point position: (</span><span class="si">%.2f</span><span class="s">, </span><span class="si">%.2f</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">)</span>
            
            <span class="n">trackFeatures</span> <span class="o">=</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">trackFeatures</span> <span class="o">==</span> <span class="s">&#39;new_centered_mask&#39;</span><span class="p">:</span>
                <span class="n">new_mask</span><span class="p">,</span> <span class="n">pts</span> <span class="o">=</span> <span class="n">createWhiteMask</span><span class="p">(</span><span class="n">frame_gray</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">new_h</span><span class="p">,</span> <span class="n">new_w</span><span class="p">)</span>
                <span class="n">p0</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[:,</span><span class="bp">None</span><span class="p">,:]</span>
            <span class="k">elif</span> <span class="n">trackFeatures</span> <span class="o">==</span> <span class="s">&#39;good_features&#39;</span><span class="p">:</span>
                <span class="n">p0</span> <span class="o">=</span> <span class="n">good_new</span><span class="p">[:,</span><span class="bp">None</span><span class="p">,:]</span>
            <span class="k">elif</span> <span class="n">trackFeatures</span> <span class="o">==</span> <span class="s">&#39;corners&#39;</span><span class="p">:</span>
                <span class="n">p0</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">goodFeaturesToTrack</span><span class="p">(</span><span class="n">frame_gray</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">feature_params</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">trackFeatures</span> <span class="o">==</span> <span class="s">&#39;corners_in_centered_mask&#39;</span><span class="p">:</span>
                <span class="n">p0</span><span class="p">,</span> <span class="n">new_mask</span> <span class="o">=</span> <span class="n">findCornersInMask</span><span class="p">(</span><span class="n">frame_gray</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">new_h</span><span class="p">,</span> <span class="n">new_w</span><span class="p">,</span> <span class="n">feature_params</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p0</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;No new corners to track&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">trackFeatures</span> <span class="o">==</span> <span class="s">&#39;append_corners_to_new_good_features_in_centered_mask&#39;</span><span class="p">:</span>
                <span class="n">new_p0</span><span class="p">,</span> <span class="n">new_mask</span> <span class="o">=</span> <span class="n">findCornersInMask</span><span class="p">(</span><span class="n">frame_gray</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">new_h</span><span class="p">,</span> <span class="n">new_w</span><span class="p">,</span> <span class="n">feature_params</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new_p0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">good_new</span><span class="p">[:,</span><span class="bp">None</span><span class="p">,:],</span> <span class="n">new_p0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p0</span> <span class="o">=</span> <span class="n">good_new</span><span class="p">[:,</span><span class="bp">None</span><span class="p">,:]</span>
            <span class="k">if</span> <span class="n">plotImageInTracking</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trackFeatures</span> <span class="o">&lt;&gt;</span> <span class="s">&#39;good_features&#39;</span> <span class="ow">and</span> <span class="n">trackFeatures</span> <span class="o">&lt;&gt;</span> <span class="s">&#39;corners&#39;</span><span class="p">:</span>
                    <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">&#39;Mask&#39;</span><span class="p">,</span><span class="n">new_mask</span><span class="p">)</span>
                
                
            <span class="k">if</span> <span class="n">plotTechniqueRes</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">or</span> <span class="n">saveTechniqueResTo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

                <span class="c"># Plot quiver</span>
                <span class="k">print</span> <span class="s">&#39;Creating quiver plot ...&#39;</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
                <span class="n">quiver_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>   <span class="n">angles</span> <span class="o">=</span> <span class="s">&#39;xy&#39;</span><span class="p">,</span> 
                                        <span class="n">scale_units</span> <span class="o">=</span> <span class="s">&#39;xy&#39;</span><span class="p">,</span>
                                        <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>
                                    <span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;kmeans_Lee2008&#39;</span><span class="p">:</span>
                    <span class="n">patches</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nClusters</span><span class="p">):</span>
                        <span class="n">D</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[</span><span class="n">label_km</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">==</span><span class="n">l</span><span class="p">]</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">D</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">D</span><span class="p">[:,</span><span class="mi">3</span><span class="p">],</span> <span class="n">D</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">D</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color_quiver</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="o">**</span><span class="n">quiver_params</span><span class="p">)</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="s">&#39;Cluster </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>                        
                        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="n">l_max</span><span class="p">:</span>
                            <span class="n">label</span> <span class="o">+=</span> <span class="s">&#39; (max)&#39;</span>
                        <span class="n">patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color_quiver</span><span class="p">[</span><span class="n">l</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">patches</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">good_x</span><span class="p">,</span> <span class="n">good_y</span><span class="p">,</span> <span class="n">good_dx</span><span class="p">,</span> <span class="n">good_dy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;g&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">quiver_params</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">bad_x</span><span class="p">,</span> <span class="n">bad_y</span><span class="p">,</span> <span class="n">bad_dx</span><span class="p">,</span> <span class="n">bad_dy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">quiver_params</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">old_cx</span><span class="p">,</span> <span class="n">old_cy</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">quiver_params</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">all_x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">all_x</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">all_y</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">all_y</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Quiver plot&#39;</span><span class="p">)</span>
                <span class="c"># Plot current and previous image</span>
                <span class="k">print</span> <span class="s">&#39;Creating raw images plots ...&#39;</span>
                <span class="n">old_frame</span> <span class="o">=</span> <span class="n">old_gray</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">old_frame2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">old_frame</span><span class="p">,</span> <span class="p">(</span><span class="n">a_rect</span><span class="p">,</span><span class="n">b_rect</span><span class="p">),(</span><span class="n">c_rect</span><span class="p">,</span><span class="n">d_rect</span><span class="p">),</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">old_frame2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">old_frame</span> <span class="o">=</span> <span class="n">old_frame2</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">old_frame</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">old_cx</span><span class="o">+</span><span class="n">cxo</span><span class="p">,</span> <span class="n">old_cy</span><span class="o">+</span><span class="n">cyo</span><span class="p">,</span> <span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">scalex</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">scaley</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Previous image&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;Lee2008&#39;</span> <span class="ow">or</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;Lee2008_v2&#39;</span><span class="p">:</span>
                    <span class="c"># Plot ordered velocities for Lee method</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                    <span class="n">idxU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">all_dx</span><span class="p">)</span>
                    <span class="n">idxV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">all_dy</span><span class="p">)</span>
                    <span class="n">U</span> <span class="o">=</span> <span class="n">all_dx</span>
                    <span class="n">V</span> <span class="o">=</span> <span class="n">all_dy</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">U</span><span class="p">[</span><span class="n">idxU</span><span class="p">])</span>
                    <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
                    <span class="n">maskLine</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymin</span> <span class="o">+</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">mask_u</span><span class="p">[</span><span class="n">idxU</span><span class="p">])</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">maskLine</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">])</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;u&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">V</span><span class="p">[</span><span class="n">idxV</span><span class="p">])</span>
                    <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
                    <span class="n">maskLine</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymin</span> <span class="o">+</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">mask_v</span><span class="p">[</span><span class="n">idxV</span><span class="p">])</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">maskLine</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">])</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;v&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

                
            <span class="k">if</span> <span class="n">saveTechniqueResTo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">folderName</span> <span class="o">=</span> <span class="n">saveTechniqueResTo</span>
                <span class="c"># Save velocity masks</span>
                <span class="k">print</span> <span class="s">&#39;Saving velocities ...&#39;</span>
                <span class="n">uMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>
                <span class="n">vMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>
                <span class="n">coordX</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_x</span><span class="o">-</span><span class="n">all_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="n">coordY</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_y</span><span class="o">-</span><span class="n">all_y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                <span class="n">uMatrix</span><span class="p">[</span><span class="n">coordY</span><span class="p">,</span> <span class="n">coordX</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_dx</span>
                <span class="n">vMatrix</span><span class="p">[</span><span class="n">coordY</span><span class="p">,</span> <span class="n">coordX</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_dy</span>
                <span class="n">header</span> <span class="o">=</span> <span class="s">&#39;AVG: </span><span class="si">%+5.3f</span><span class="s">; MEDIAN: </span><span class="si">%+5.3f</span><span class="s">; STDDEV: </span><span class="si">%+5.3f</span><span class="s">; MIN: </span><span class="si">%+5.3f</span><span class="s">; MAX: </span><span class="si">%+5.3f</span><span class="s">;&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">uMatrix</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">uMatrix</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">uMatrix</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">uMatrix</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">uMatrix</span><span class="p">))</span>
                <span class="n">filePath</span> <span class="o">=</span> <span class="n">folderName</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%04d</span><span class="s">_U.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">uMatrix</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%+5.3f</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
                <span class="n">header</span> <span class="o">=</span> <span class="s">&#39;AVG: </span><span class="si">%+5.3f</span><span class="s">; MEDIAN: </span><span class="si">%+5.3f</span><span class="s">; STDDEV: </span><span class="si">%+5.3f</span><span class="s">; MIN: </span><span class="si">%+5.3f</span><span class="s">; MAX: </span><span class="si">%+5.3f</span><span class="s">;&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vMatrix</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vMatrix</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">vMatrix</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">vMatrix</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">vMatrix</span><span class="p">))</span>
                <span class="n">filePath</span> <span class="o">=</span> <span class="n">folderName</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%04d</span><span class="s">_V.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">vMatrix</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%+5.3f</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
                <span class="n">filePath</span> <span class="o">=</span> <span class="n">folderName</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%04d</span><span class="s">_uv.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%+5.3f</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="s">&#39;Final (u, v)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;Lee2008&#39;</span> <span class="ow">or</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;Lee2008_v2&#39;</span><span class="p">:</span>
                    <span class="c"># Save velocity masks</span>
                    <span class="k">print</span> <span class="s">&#39;Saving velocity masks ...&#39;</span>
                    <span class="n">uMaskMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>
                    <span class="n">vMaskMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>
                    <span class="n">uMatrix</span><span class="p">[</span><span class="n">coordY</span><span class="p">,</span> <span class="n">coordX</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_dx</span>
                    <span class="n">vMatrix</span><span class="p">[</span><span class="n">coordY</span><span class="p">,</span> <span class="n">coordX</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_dy</span>
                    <span class="n">uMaskMatrix</span><span class="p">[</span><span class="n">coordY</span><span class="p">,</span> <span class="n">coordX</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_u</span>
                    <span class="n">vMaskMatrix</span><span class="p">[</span><span class="n">coordY</span><span class="p">,</span> <span class="n">coordX</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_v</span>
                    <span class="n">header</span> <span class="o">=</span> <span class="s">&#39;0: excluded (low); 1: used for avg; 2,3: excluded (high)&#39;</span>
                    <span class="n">filePath</span> <span class="o">=</span> <span class="n">folderName</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%04d</span><span class="s">_U_mask.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">uMaskMatrix</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%1d</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
                    <span class="n">filePath</span> <span class="o">=</span> <span class="n">folderName</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%04d</span><span class="s">_V_mask.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">vMaskMatrix</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%1d</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
                    <span class="c"># Save some indices</span>
                    <span class="n">Uex</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="n">mask_u</span><span class="o">==</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">u_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Uex</span><span class="p">)</span>
                    <span class="n">idx1u</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_ex</span> <span class="o">-</span> <span class="n">u</span><span class="p">)</span> <span class="o">/</span> <span class="n">u_ex</span>
                    <span class="n">Vex</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="n">mask_v</span><span class="o">==</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">v_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Vex</span><span class="p">)</span>
                    <span class="n">idx1v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_ex</span> <span class="o">-</span> <span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="n">v_ex</span>
                    <span class="n">Ulow</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="n">mask_u</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">u_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Ulow</span><span class="p">)</span>
                    <span class="n">idx2u</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">u_low</span><span class="p">)</span> <span class="o">/</span> <span class="n">u</span>
                    <span class="n">Vlow</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="n">mask_v</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">v_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Vlow</span><span class="p">)</span>
                    <span class="n">idx2v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">v_low</span><span class="p">)</span> <span class="o">/</span> <span class="n">v</span>
                    <span class="n">filePath</span> <span class="o">=</span> <span class="n">folderName</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%04d</span><span class="s">_indices_check_Lee.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;(AVG(Uex) - u) / AVG(Uex): </span><span class="si">%+5.3f</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">idx1u</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;(AVG(Vex) - v) / AVG(Vex): </span><span class="si">%+5.3f</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">idx1v</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;(u - AVG(Ulow)) / u: </span><span class="si">%+5.3f</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">idx2u</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;(v - AVG(Vlow)) / v: </span><span class="si">%+5.3f</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">idx2v</span><span class="p">)</span>
                <span class="c"># Save optical flow errors</span>
                <span class="n">header</span> <span class="o">=</span> <span class="s">&#39;AVG: </span><span class="si">%+5.3f</span><span class="s">; MEDIAN: </span><span class="si">%+5.3f</span><span class="s">; STDDEV: </span><span class="si">%+5.3f</span><span class="s">; MIN: </span><span class="si">%+5.3f</span><span class="s">; MAX: </span><span class="si">%+5.3f</span><span class="s">;&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mask_err_fun</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">mask_err_fun</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">mask_err_fun</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mask_err_fun</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mask_err_fun</span><span class="p">))</span>
                <span class="n">filePath</span> <span class="o">=</span> <span class="n">folderName</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%04d</span><span class="s">_err_LK_fun.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">mask_err_fun</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%+5.3f</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
                <span class="n">header</span> <span class="o">=</span> <span class="s">&#39;AVG: </span><span class="si">%+5.3f</span><span class="s">; MEDIAN: </span><span class="si">%+5.3f</span><span class="s">; STDDEV: </span><span class="si">%+5.3f</span><span class="s">; MIN: </span><span class="si">%+5.3f</span><span class="s">; MAX: </span><span class="si">%+5.3f</span><span class="s">;&#39;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mask_err_OF</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">mask_err_OF</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">mask_err_OF</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mask_err_OF</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mask_err_OF</span><span class="p">))</span>
                <span class="n">filePath</span> <span class="o">=</span> <span class="n">folderName</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%04d</span><span class="s">_err_brightness_constancy.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">mask_err_OF</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%+5.3f</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&#39;Saving figures ...&#39;</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">filePath</span> <span class="o">=</span> <span class="n">folderName</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%04d</span><span class="s">_OF.jpeg&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;jpeg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;Lee2008&#39;</span> <span class="ow">or</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&#39;Lee2008_v2&#39;</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">filePath</span> <span class="o">=</span> <span class="n">folderName</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%04d</span><span class="s">_OF_vel_Lee.jpeg&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;jpeg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
                
<span class="c">#            if plotTechniqueRes:</span>
<span class="c">#                print &#39;Plotting data ...&#39;</span>
<span class="c">#                plt.show()</span>
                
        <span class="k">elif</span> <span class="n">technique</span> <span class="o">==</span> <span class="s">&#39;template_match&#39;</span><span class="p">:</span>
            
            <span class="n">a_rect</span><span class="p">,</span> <span class="n">c_rect</span> <span class="o">=</span> <span class="n">old_cx</span><span class="o">-</span><span class="p">(</span><span class="n">w</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">old_cx</span><span class="o">+</span><span class="p">(</span><span class="n">w</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">b_rect</span><span class="p">,</span> <span class="n">d_rect</span> <span class="o">=</span> <span class="n">old_cy</span><span class="o">-</span><span class="p">(</span><span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">old_cy</span><span class="o">+</span><span class="p">(</span><span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">old_gray</span><span class="p">[</span><span class="n">b_rect</span><span class="p">:</span><span class="n">d_rect</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">a_rect</span><span class="p">:</span><span class="n">c_rect</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">hSrch</span> <span class="o">=</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">wSrch</span> <span class="o">=</span> <span class="n">techniquePars</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">a_rect2</span><span class="p">,</span> <span class="n">c_rect2</span> <span class="o">=</span> <span class="n">a_rect</span><span class="o">-</span><span class="n">wSrch</span><span class="p">,</span> <span class="n">c_rect</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">wSrch</span>
            <span class="n">b_rect2</span><span class="p">,</span> <span class="n">d_rect2</span> <span class="o">=</span> <span class="n">b_rect</span><span class="o">-</span><span class="n">hSrch</span><span class="p">,</span> <span class="n">d_rect</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">hSrch</span>
            <span class="n">search_win</span> <span class="o">=</span> <span class="n">frame_gray</span><span class="p">[</span><span class="n">b_rect2</span><span class="p">:</span><span class="n">d_rect2</span><span class="p">,</span><span class="n">a_rect2</span><span class="p">:</span><span class="n">c_rect2</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">matchTemplate</span><span class="p">(</span><span class="n">search_win</span><span class="p">,</span><span class="n">template</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">TM_CCORR_NORMED</span><span class="p">)</span>
            <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">min_loc</span><span class="p">,</span> <span class="n">max_loc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">minMaxLoc</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="n">top_left</span> <span class="o">=</span> <span class="n">max_loc</span>
            <span class="n">cx</span> <span class="o">=</span> <span class="n">a_rect2</span> <span class="o">+</span> <span class="n">top_left</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">w</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">cy</span> <span class="o">=</span> <span class="n">b_rect2</span> <span class="o">+</span> <span class="n">top_left</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            
            <span class="c"># Use manually inputted cxy if existing</span>
            <span class="k">if</span> <span class="n">f1</span><span class="o">+</span><span class="n">fr</span> <span class="ow">in</span> <span class="n">cxyHelp</span><span class="p">:</span>
                <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">cxyHelp</span><span class="p">[</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">cxo</span><span class="p">,</span> <span class="n">cxyHelp</span><span class="p">[</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">cyo</span>
                <span class="k">print</span> <span class="s">&#39;Point adjusted manually&#39;</span>
            
            <span class="k">if</span> <span class="n">plotImageInTracking</span><span class="p">:</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">&#39;Template&#39;</span><span class="p">,</span><span class="n">template</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">plotTechniqueRes</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">or</span> <span class="n">saveTechniqueResTo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                <span class="c"># Plot images</span>
                <span class="k">print</span> <span class="s">&#39;Creating images plots ...&#39;</span>
                <span class="n">old_frame</span> <span class="o">=</span> <span class="n">old_gray</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">old_frame2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">old_frame</span><span class="p">,</span> <span class="p">(</span><span class="n">a_rect</span><span class="p">,</span><span class="n">b_rect</span><span class="p">),(</span><span class="n">c_rect</span><span class="p">,</span><span class="n">d_rect</span><span class="p">),</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">old_frame2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">old_frame</span> <span class="o">=</span> <span class="n">old_frame2</span>
                <span class="n">curr_frame</span> <span class="o">=</span> <span class="n">frame_gray</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">curr_frame2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">curr_frame</span><span class="p">,</span> <span class="p">(</span><span class="n">a_rect2</span><span class="p">,</span><span class="n">b_rect2</span><span class="p">),(</span><span class="n">c_rect2</span><span class="p">,</span><span class="n">d_rect2</span><span class="p">),</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">curr_frame2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">curr_frame</span> <span class="o">=</span> <span class="n">curr_frame2</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">221</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">old_frame</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Previous image (template)&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">222</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">curr_frame</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Current image (search win)&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">scalex</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">scaley</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cx</span><span class="o">+</span><span class="n">cxo</span><span class="p">,</span> <span class="n">cy</span><span class="o">+</span><span class="n">cyo</span><span class="p">,</span> <span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">scalex</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">scaley</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">224</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Matching index (max = </span><span class="si">%.3f</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">max_val</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">top_left</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">top_left</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;o&#39;</span><span class="p">,</span> <span class="n">mfc</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">scalex</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">scaley</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">hold</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">saveTechniqueResTo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;Saving figures ...&#39;</span>
                <span class="n">folderName</span> <span class="o">=</span> <span class="n">saveTechniqueResTo</span>
                <span class="n">filePath</span> <span class="o">=</span> <span class="n">folderName</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%04d</span><span class="s">_TM.jpeg&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;jpeg&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&#39;Saving NCCs profile ...&#39;</span>
                <span class="n">filePath</span> <span class="o">=</span> <span class="n">folderName</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%04d</span><span class="s">_NCC.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%+5.3f</span><span class="s">&#39;</span><span class="p">)</span>
                
<span class="c">#            if plotTechniqueRes:</span>
<span class="c">#                print &#39;Plotting data ...&#39;</span>
<span class="c">#                plt.show()</span>
            
        <span class="k">else</span><span class="p">:</span>
            
            <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
             
            
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cx</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="c"># Show circle</span>
            <span class="k">if</span> <span class="n">plotCircle</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">mask_circle2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">mask_circle</span><span class="p">,(</span><span class="nb">int</span><span class="p">(</span><span class="n">cx</span><span class="o">+</span><span class="n">cxo</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">cy</span><span class="o">+</span><span class="n">cyo</span><span class="p">)),</span><span class="mi">5</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mask_circle2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">mask_circle</span> <span class="o">=</span> <span class="n">mask_circle2</span>
            <span class="k">elif</span> <span class="n">plotCircle</span> <span class="o">==</span> <span class="s">&#39;last&#39;</span><span class="p">:</span>
                <span class="n">mask_empty2</span> <span class="o">=</span> <span class="n">mask_empty</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">mask2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">mask_empty2</span><span class="p">,(</span><span class="nb">int</span><span class="p">(</span><span class="n">cx</span><span class="o">+</span><span class="n">cxo</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">cy</span><span class="o">+</span><span class="n">cyo</span><span class="p">)),</span><span class="mi">5</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mask2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">mask_empty2</span> <span class="o">=</span> <span class="n">mask2</span>
                <span class="n">mask_circle</span> <span class="o">=</span> <span class="n">mask_empty2</span>
            
        <span class="c"># Add good features mask to circle mask</span>
        <span class="n">idx_nonblack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask_circle</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_good</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">idx_nonblack</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_circle</span><span class="p">[</span><span class="n">idx_nonblack</span><span class="p">]</span>
        
        <span class="c"># Add mask to image</span>
        <span class="n">idx_nonblack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">frame_col</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">img</span><span class="p">[</span><span class="n">idx_nonblack</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">idx_nonblack</span><span class="p">]</span>
        
        <span class="c"># Convert image with tracked point plotted back to gray</span>
        <span class="n">img_gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="n">Iout</span><span class="p">[</span><span class="n">fr</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_gray</span>
    
        <span class="c"># Show image</span>
        <span class="k">if</span> <span class="n">plotImageInTracking</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">&#39;Tracking&#39;</span><span class="p">,</span><span class="n">img</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timePerImage</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">27</span><span class="p">:</span>
                <span class="k">break</span>
            
        <span class="c"># Calculate general errors</span>
        <span class="n">all_new</span> <span class="o">=</span> <span class="n">p0</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]</span>
        <span class="n">all_new_r</span><span class="p">,</span> <span class="n">all_new_c</span> <span class="o">=</span> <span class="n">all_new</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">all_new</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">mask_err_patch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>
        <span class="n">mask_err_patch</span><span class="p">[</span><span class="n">all_old_r</span><span class="o">-</span><span class="n">br</span><span class="p">,</span><span class="n">all_old_c</span><span class="o">-</span><span class="n">ar</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">frame_gray</span><span class="p">[</span><span class="n">all_new_r</span><span class="p">,</span><span class="n">all_new_c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">-</span> 
                                                      <span class="n">old_gray</span><span class="p">[</span><span class="n">all_old_r</span><span class="p">,</span><span class="n">all_old_c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
            
        <span class="k">if</span> <span class="n">saveTechniqueResTo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  
            <span class="c"># Save general errors info  </span>
            <span class="n">header</span> <span class="o">=</span> <span class="s">&#39;AVG: </span><span class="si">%+5.3f</span><span class="s">; MEDIAN: </span><span class="si">%+5.3f</span><span class="s">; STDDEV: </span><span class="si">%+5.3f</span><span class="s">; MIN: </span><span class="si">%+5.3f</span><span class="s">; MAX: </span><span class="si">%+5.3f</span><span class="s">;&#39;</span> \
            <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mask_err_patch</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">mask_err_patch</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">mask_err_patch</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mask_err_patch</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mask_err_patch</span><span class="p">))</span>
            <span class="n">filePath</span> <span class="o">=</span> <span class="n">folderName</span> <span class="o">+</span> <span class="s">&#39;/</span><span class="si">%04d</span><span class="s">_err_patch.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">mask_err_patch</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%+5.3f</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">plotTechniqueRes</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Plotting data ...&#39;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
        <span class="c"># Now update the previous frame</span>
        <span class="n">old_gray</span> <span class="o">=</span> <span class="n">frame_gray</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">cx_res</span><span class="p">[</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">],</span> <span class="n">cy_res</span><span class="p">[</span><span class="n">f1</span><span class="o">+</span><span class="n">fr</span><span class="p">]</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">cx</span> <span class="o">+</span> <span class="n">cxo</span><span class="p">,</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">cy</span> <span class="o">+</span> <span class="n">cyo</span>
    
    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
    
    <span class="c"># Export files</span>
    <span class="k">for</span> <span class="n">outFile</span> <span class="ow">in</span> <span class="n">outFiles</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">outFile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fps</span> <span class="o">=</span> <span class="n">outFile</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fps</span> <span class="o">==</span> <span class="s">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">fps</span> <span class="o">=</span> <span class="n">frame_rate</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">getFileExt</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&#39;avi&#39;</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Saving file </span><span class="si">%s</span><span class="s"> ...&#39;</span> <span class="o">%</span> <span class="n">file_name</span>
            <span class="n">arr2aviMPY</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">Iout</span><span class="p">,</span> <span class="n">fps</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;File saved&#39;</span>
    
    <span class="c"># Return data</span>
    <span class="k">return</span> <span class="n">cx_res</span><span class="p">,</span> <span class="n">cy_res</span>
    
    </div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Py3DFreeHandUS 1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Davide Monari.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>